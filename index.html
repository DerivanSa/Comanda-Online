<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Comanda Online</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css">
</head>
<body>
    <div id="main-container">
        <header>
            <img src="logo.png" alt="Logo Comanda Online" id="site-logo">
        </header>
        <form id="initial-form">
            <label for="restaurant-name">Nome do Restaurante:</label>
            <input type="text" id="restaurant-name">
            <label for="waiter-name">Nome do Garçom:</label>
            <input type="text" id="waiter-name">
            <button type="button" id="start-btn">Iniciar</button>
        </form>

        <form id="comanda-form" class="hidden">
            <h2>Criar Comanda</h2>
            <button type="button" id="create-comanda-btn">Criar Comanda</button>
        </form>

        <div id="comanda-section" class="hidden">
            <div class="header">
                <h2>Comanda</h2>
                <button id="view-list-btn"><i class="fas fa-clipboard-list"></i> Ver Lista</button>
            </div>
            <p><strong>Restaurante:</strong> <span id="comanda-restaurant-name"></span></p>
            <p><strong>Garçom:</strong> <span id="comanda-waiter-name"></span></p>
            <p><strong>Data:</strong> <span id="comanda-date"></span></p>
            <p><strong>Mesa:</strong> <span id="comanda-table-number"></span></p>
            <p><strong>ID:</strong> <span id="comanda-id"></span></p>
            <p><strong>Status:</strong> <span id="comanda-status"></span></p>
            <label for="client-name">Nome do Cliente:</label>
            <input type="text" id="client-name">
            <label for="client-contact">Contato do Cliente:</label>
            <input type="text" id="client-contact">
            <label for="observations">Observações:</label>
            <textarea id="observations"></textarea>
            <label for="discount">Desconto:</label>
            <input type="text" id="discount">
            <label for="discount-type">Tipo de Desconto:</label>
            <select id="discount-type">
                <option value="percent">Porcentagem</option>
                <option value="value">Valor Real</option>
            </select>
            <p><strong>Valor Total:</strong> R$ <span id="total-value">0.00</span></p>
            <p><strong>Valor com Desconto:</strong> R$ <span id="discounted-value">0.00</span></p>
            <table>
                <thead>
                    <tr>
                        <th>Quantidade</th>
                        <th>Produto</th>
                        <th>Preço</th>
                    </tr>
                </thead>
                <tbody id="items-tbody"></tbody>
            </table>
            <button type="button" id="add-items-btn">Adicionar Itens</button>
            <button type="button" id="save-image-btn">Salvar como Imagem</button>
            <button type="button" id="close-comanda-btn">Fechar Comanda</button>
        </div>

        <h2>Comandas</h2>
        <ul id="comandas-ul"></ul>
        <button type="button" id="download-json-btn">Baixar JSON</button>

        <footer>
            <p>Copyright <a href="https://github.com/DerivanSa" target="_blank">Derivan Souza</a> - Projeto <a href="https://github.com/DerivanSa/Comanda-Online" target="_blank">Comanda Online</a></p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialForm = document.getElementById('initial-form');
            const startBtn = document.getElementById('start-btn');
            const comandaForm = document.getElementById('comanda-form');
            const createComandaBtn = document.getElementById('create-comanda-btn');
            const comandaSection = document.getElementById('comanda-section');
            const comandaRestaurantName = document.getElementById('comanda-restaurant-name');
            const comandaWaiterName = document.getElementById('comanda-waiter-name');
            const comandaDate = document.getElementById('comanda-date');
            const comandaTableNumber = document.getElementById('comanda-table-number');
            const comandaId = document.getElementById('comanda-id');
            const comandaStatus = document.getElementById('comanda-status');
            const itemsTbody = document.getElementById('items-tbody');
            const addItemsBtn = document.getElementById('add-items-btn');
            const totalValue = document.getElementById('total-value');
            const discountInput = document.getElementById('discount');
            const discountType = document.getElementById('discount-type');
            const discountedValue = document.getElementById('discounted-value');
            const saveImageBtn = document.getElementById('save-image-btn');
            const closeComandaBtn = document.getElementById('close-comanda-btn');
            const comandasUl = document.getElementById('comandas-ul');
            const downloadJsonBtn = document.getElementById('download-json-btn');
            const clientNameInput = document.getElementById('client-name');
            const clientContactInput = document.getElementById('client-contact');
            const observationsInput = document.getElementById('observations');
            const viewListBtn = document.getElementById('view-list-btn');

            let comandas = getComandasFromCookies();
            let nextId = comandas.length ? Math.max(...comandas.map(c => c.id)) + 1 : 1;
            let restaurantNameCache = localStorage.getItem('restaurantName');
            let waiterNameCache = localStorage.getItem('waiterName');

            if (restaurantNameCache && waiterNameCache) {
                document.getElementById('restaurant-name').value = restaurantNameCache;
                document.getElementById('waiter-name').value = waiterNameCache;
                initialForm.classList.add('hidden');
                comandaForm.classList.remove('hidden');
            }

            startBtn.addEventListener('click', () => {
                const restaurantName = document.getElementById('restaurant-name').value;
                const waiterName = document.getElementById('waiter-name').value;

                if (restaurantName && waiterName) {
                    localStorage.setItem('restaurantName', restaurantName);
                    localStorage.setItem('waiterName', waiterName);

                    initialForm.classList.add('hidden');
                    comandaForm.classList.remove('hidden');
                } else {
                    alert('Por favor, preencha todos os campos.');
                }
            });

            createComandaBtn.addEventListener('click', () => {
                const restaurantName = localStorage.getItem('restaurantName');
                const waiterName = localStorage.getItem('waiterName');

                const tableNumber = prompt('Número da mesa:');
                const id = nextId++;
                const date = new Date().toLocaleString();

                comandaRestaurantName.textContent = restaurantName;
                comandaWaiterName.textContent = waiterName;
                comandaDate.textContent = date;
                comandaTableNumber.textContent = tableNumber;
                comandaId.textContent = id;

                comandaForm.classList.add('hidden');
                comandaSection.classList.remove('hidden');

                const comanda = {
                    id,
                    restaurantName,
                    waiterName,
                    date,
                    tableNumber,
                    status: 'Aberta',
                    items: [],
                    clientName: '',
                    clientContact: '',
                    observations: '',
                    discount: '',
                    discountType: 'percent'
                };

                comandas.push(comanda);
                saveComandaToCookies(comandas);
                updateComandasList();

                addItemsToTable(30);
            });

            addItemsBtn.addEventListener('click', () => {
                addItemsToTable(20);
            });

            closeComandaBtn.addEventListener('click', () => {
                const comanda = getCurrentComanda();
                comanda.status = 'Fechada';
                comandaStatus.textContent = 'Fechada';
                comandaStatus.className = 'status-closed';
                saveComandaToCookies(comandas);
                updateComandasList();
            });

            discountInput.addEventListener('input', calculateTotal);
            discountType.addEventListener('change', calculateTotal);

            clientNameInput.addEventListener('input', saveCurrentComandaDetails);
            clientContactInput.addEventListener('input', saveCurrentComandaDetails);
            observationsInput.addEventListener('input', saveCurrentComandaDetails);
            discountInput.addEventListener('input', saveCurrentComandaDetails);
            discountType.addEventListener('change', saveCurrentComandaDetails);

            saveImageBtn.addEventListener('click', () => {
                html2canvas(document.querySelector("#comanda-section")).then(canvas => {
                    const a = document.createElement('a');
                    a.href = canvas.toDataURL("image/png");
                    a.download = `comanda-${getCurrentComanda().id}.png`;
                    a.click();
                });
            });

            viewListBtn.addEventListener('click', () => {
                window.location.href = window.location.origin + window.location.pathname;
            });

            function addItemsToTable(count) {
                for (let i = 0; i < count; i++) {
                    const tr = document.createElement('tr');
                    const tdQuantity = document.createElement('td');
                    const tdProduct = document.createElement('td');
                    const tdPrice = document.createElement('td');

                    tdQuantity.innerHTML = '<input type="number" min="0" step="1" value="0">';
                    tdProduct.innerHTML = '<input type="text" value="">';
                    tdPrice.innerHTML = '<input type="number" min="0" step="0.01" value="0.00">';

                    tr.appendChild(tdQuantity);
                    tr.appendChild(tdProduct);
                    tr.appendChild(tdPrice);

                    itemsTbody.appendChild(tr);
                }

                itemsTbody.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        saveCurrentComandaItems();
                        calculateTotal();
                    });
                });
            }

            function calculateTotal() {
                let total = 0;

                itemsTbody.querySelectorAll('tr').forEach(tr => {
                    const quantity = parseFloat(tr.children[0].children[0].value) || 0;
                    const price = parseFloat(tr.children[2].children[0].value) || 0;
                    total += quantity * price;
                });

                totalValue.textContent = total.toFixed(2);

                const discount = parseFloat(discountInput.value) || 0;
                const discountIsPercent = discountType.value === 'percent';
                const discountedTotal = discountIsPercent ? total - (total * discount / 100) : total - discount;
                discountedValue.textContent = discountedTotal.toFixed(2);
            }

            function saveCurrentComandaItems() {
                const comanda = getCurrentComanda();
                comanda.items = [];

                itemsTbody.querySelectorAll('tr').forEach(tr => {
                    const quantity = parseFloat(tr.children[0].children[0].value) || 0;
                    const product = tr.children[1].children[0].value;
                    const price = parseFloat(tr.children[2].children[0].value) || 0;

                    if (quantity && product && price) {
                        comanda.items.push({ quantity, product, price });
                    }
                });

                saveComandaToCookies(comandas);
                updateComandasList();
            }

            function saveCurrentComandaDetails() {
                const comanda = getCurrentComanda();
                comanda.clientName = clientNameInput.value;
                comanda.clientContact = clientContactInput.value;
                comanda.observations = observationsInput.value;
                comanda.discount = discountInput.value;
                comanda.discountType = discountType.value;

                saveComandaToCookies(comandas);
                updateComandasList();
            }

            downloadJsonBtn.addEventListener('click', () => {
                const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(comandas));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute('href', dataStr);
                downloadAnchorNode.setAttribute('download', 'comandas.json');
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    const comanda = comandas.find(comanda => comanda.id == hash);
                    if (comanda) {
                        loadComanda(comanda);
                    }
                }
            });

            function getCurrentComanda() {
                const id = parseInt(comandaId.textContent);
                return comandas.find(comanda => comanda.id === id);
            }

            function loadComanda(comanda) {
                comandaRestaurantName.textContent = comanda.restaurantName;
                comandaWaiterName.textContent = comanda.waiterName;
                comandaDate.textContent = comanda.date;
                comandaTableNumber.textContent = comanda.tableNumber;
                comandaId.textContent = comanda.id;
                comandaStatus.textContent = comanda.status;
                comandaStatus.className = comanda.status === 'Aberta' ? 'status-open' : 'status-closed';

                clientNameInput.value = comanda.clientName;
                clientContactInput.value = comanda.clientContact;
                observationsInput.value = comanda.observations;
                discountInput.value = comanda.discount;
                discountType.value = comanda.discountType;

                itemsTbody.innerHTML = '';

                comanda.items.forEach(item => {
                    const tr = document.createElement('tr');
                    const tdQuantity = document.createElement('td');
                    const tdProduct = document.createElement('td');
                    const tdPrice = document.createElement('td');

                    tdQuantity.innerHTML = `<input type="number" min="0" step="1" value="${item.quantity}">`;
                    tdProduct.innerHTML = `<input type="text" value="${item.product}">`;
                    tdPrice.innerHTML = `<input type="number" min="0" step="0.01" value="${item.price.toFixed(2)}">`;

                    tr.appendChild(tdQuantity);
                    tr.appendChild(tdProduct);
                    tr.appendChild(tdPrice);

                    itemsTbody.appendChild(tr);
                });

                itemsTbody.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        saveCurrentComandaItems();
                        calculateTotal();
                    });
                });

                comandaForm.classList.add('hidden');
                comandaSection.classList.remove('hidden');
                calculateTotal();
            }

            function updateComandasList() {
                    comandasUl.innerHTML = '';
                    comandas.forEach(comanda => {
                        const li = document.createElement('li');
                        const clientName = comanda.clientName ? ` - Cliente: ${comanda.clientName}` : '';
                        const value = comanda.items.reduce((acc, item) => acc + item.quantity * item.price, 0).toFixed(2);
                        li.innerHTML = `<i class="fas fa-clipboard-list"></i> Comanda ${comanda.id} - Mesa ${comanda.tableNumber} - ${comanda.status}${clientName} - ${comanda.date} - R$ ${value}`;
                        li.className = comanda.status === 'Aberta' ? 'status-open' : 'status-closed';
                        li.addEventListener('click', () => {
                            window.location.hash = comanda.id;
                        });
                        comandasUl.appendChild(li);
                    });
                }

                function getComandasFromCookies() {
                    const comandasStr = localStorage.getItem('comandas');
                    return comandasStr ? JSON.parse(comandasStr) : [];
                }

                function saveComandaToCookies(comandas) {
                    localStorage.setItem('comandas', JSON.stringify(comandas));
                }

                updateComandasList();
            });
    </script>
</body>
</html>
